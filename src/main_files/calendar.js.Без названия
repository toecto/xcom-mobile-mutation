function checkout_calendar(basket_handler, input_id)
{
    var allow_select = 0;

    var dow = {0: 'вс', 1: 'пн', 2: 'вт', 3: 'ср', 4: 'чт', 5: 'пт', 6: 'сб', 7: 'вс'};
    var month = {
        1: 'Январь', 2: 'Февраль', 3: 'Март', 
        4: 'Апрель', 5: 'Май', 6: 'Июнь', 
        7: 'Июль', 8: 'Август', 9: 'Сентябрь', 
        10: 'Октябрь', 11: 'Ноябрь', 12: 'Декабрь'
    };


    var $calendar_container = $(input_id);

    if (!$calendar_container.length) {
        return;
    }


    var _this = this;
    this.basket_handler = basket_handler;

    this.basket_handler.callbackCalendar = function() {
        $.get(
            '/ajax_request/',
            {
                interface: 'order_lifetime_controller',
                action: 'getCalendar'
            },
            _this.status_handler,
            'json'
        );
    }

    this.status_handler = function(data) {
        _this.data = data;

        _this.data['estimated'] += '';

        var delivery = parseInt(_this.basket_handler.basket.dlv.delivery);

        if (data == 0) {
            var grid_html = '';
            if(delivery == 5) {
                grid_html += '<p>Дату поступления в пункт выдачи <span>уточняйте у менеджера</span>.</p>';
            } else {
                grid_html += '<p>Дату доставки <span>уточняйте у менеджера</span>.</p>';
            }
            grid_html += '<input id="calendar_input" name="dlv_prefer_dtime" value="0" class="hide" />';
            $calendar_container.html(grid_html);
            return;
        }

        if (delivery != 5) {
            var title;
            if (delivery == 1) {
                title = '<span>доставки</span>';
                allow_select = 1;
            } else {
                allow_select = 0;
                title = '<span>передачи</span> ';
                switch(delivery) {
                    case 3:
                        title += 'в ТК &laquo;Грузовозофф&raquo;';
                        break;
                    case 4:
                        title += 'в курьерскую службу СПСР';
                        break;
                    case 6:
                    case 7:
                        title += 'в EMS Почта России';
                        break;
                    case 36:
                    case 37:
                        title += 'в EMS-ИдеаЛоджик';
                        break;
                    case 8:
                    case 9:
                        title += 'в ТК &laquo;ПЭК&raquo;';
                        break;
                    case 21:
                    case 22:
                    case 23:
                    case 24:
                    case 25:
                    case 26:
                        title += 'в ТК &laquo;DPD&raquo;';
                        break;
                    default:
                        title += 'курьерским службам';
                }
            }

            if (delivery == 1) {
                title = 'Выберите день ' + title;
            } else {
                title = 'День ' + title;
            }
            showCalendar(title);

            _rt('#day_'+_this.data['today']).first().className += ' today';
        } else {
            var grid_html = '<p class="oneline">Ожидаемая дата поступления в пункт выдачи <span>'+_this.data['estimated'].slice(6)+'.'+_this.data['estimated'].slice(4,6)+'.'+_this.data['estimated'].slice(0,4)+'</span></p>';
            grid_html += '<input id="calendar_input" name="dlv_prefer_dtime" value="" class="hide" />';
            $calendar_container.html(grid_html);
            _rt('#calendar_input').value(''+_this.data['estimated']);
        }
    }

    this.basket_handler.callbackCalendar();


    function showCalendar(title)
    {
        var grid_html = '<p>'+title+'</p>';
        grid_html += '<input id="calendar_input" name="dlv_prefer_dtime" value="" class="hide" />';
        $calendar_container.html(grid_html);

        var calendar_box = _rt('#calendar_box');

        for (var y in _this.data['days']) {
            for (var m in _this.data['days'][y]) {
                $calendar_container.append('<div class="month_name" id="month_name_'+m+'"><p>'+month[m]+'</p></div>');
                $calendar_container.append('<div class="dow_line" id="dow_line_'+m+'"></div>');
                
                for (var i=1; i<=7; i++) {
                    _rt('#dow_line_'+m).append('<div class="dow_'+i+'">'+dow[i]+'</div>');
                }

                _rt('.dow_line .dow_6').add('.dow_line .dow_7').set({className:'color_red'});

                if (allow_select) {
                    $calendar_container.append('<div class="days" id="days_'+m+'"></div><br />');
                } else {
                    $calendar_container.append('<div class="days noselect" id="days_'+m+'"></div><br />');
                }

                var c_dow = 0;
                for (var d in _this.data['days'][y][m]) {
                    var c_inner = '';
                    var c_outer = 'one_day';
                    var ymd = y;
                    ymd += (m<10) ? '0'+m : m;
                    ymd += (_this.data['days'][y][m][d]<10) ? '0'+_this.data['days'][y][m][d] : _this.data['days'][y][m][d];

                    c_dow++;
                    if (c_dow > 7) {
                        c_dow = 1;
                    }

                    if (c_dow == 6 || c_dow == 7) {
                        c_outer += ' red_day';
                    }

                    if (checkEnabled(''+ymd) == 0) {
                        c_inner += ' disabled';
                    } else {
                        c_inner += ' enabled';
                    }

                    if (_this.data['days'][y][m][d] == 0) {
                        _rt('#days_'+m).append('<div class="clear_day"></div>');
                    } else {
                        _rt('#days_'+m).append('<div class="'+c_outer+'"><div class="'+c_inner+'" id="day_'+ymd+'">'+_this.data['days'][y][m][d]+'</div></div>');
                    }
                }
            }
        }

        if (_this.basket_handler.basket.dlv.delivery == 1) {
            t = _rt('.days .enabled').first().id.split('_');
            if (t != false) {
                setSelectedValue(t[1]);
            }
            _rt('.days .enabled').bind('click',setCurrent_handler);
        } else {
            t = _rt('.days .enabled').first().id.split('_');
            if (t != false) {
                setCurrent(t[1]);
            }
        }
        _rt('.one_day div').bind('mouseover',showMsg_handler);
        _rt('.one_day').bind('mouseout',clearMsg_handler);
    }

    function checkEnabled(ymd)
    {
        var f = 0;
        if (_this.data['exceptions'][''+ymd] === 1) {
            f = 1;
        }

        if (ymd < _this.data['estimated'] || f == 1) {
            return 0;
        }

        return 1;
    }

    function setCurrent_handler(event)
    {
        event = _rt().getEvent(event);
        var t = _rt(event).first().id.split('_');
        if (t != false) {
            setCurrent(t[1]);
        }
    }

    function setCurrent(ymd)
    {
        if (checkEnabled(ymd) == 1) {
            setSelectedValue(ymd);
        }
        selectDay(ymd);
    }

    function setSelectedValue(ymd)
    {
        _rt('#calendar_input').value('' + ymd);
    }

    function selectDay(ymd)
    {
        var o = _rt('.days .selected').first();
        if (o != false) {
            o.className = o.className.replace('selected','');
        }
        _rt('#day_'+ymd).first().parentNode.className += ' selected';
    }

    function showMsg_handler(event)
    {
        event = _rt().getEvent(event);
        if (_rt(event).first().className.indexOf('enabled') != -1) {
            showMsg('Можно выбрать.');
        }

        if (_rt(event).first().className.indexOf('today') != -1) {
            if (_rt(event).first().parentNode.className.indexOf('selected') != -1) {
                showMsg('Сегодня. Выбран.');
            } else {
                showMsg('Сегодня.');
            }
        } else {
            if (_rt(event).first().parentNode.className.indexOf('selected') != -1) {
                showMsg('Выбран.');
            }
        }

        if (_rt(event).first().className.indexOf('disabled') != -1) {
            showMsg('Доставка в&nbsp;этот день уже невозможна, извините.');
        }
    }

    function showMsg(msg){_rt('#calendar_tip').html(msg);}

    function clearMsg_handler(event){_rt('#calendar_tip').html('');}
}
